name: Performance Benchmark

on:
  push:
    branches: [main, performance]
  pull_request:
    branches: [main]
  schedule:
    # Run weekly on Sunday at 00:00 UTC
    - cron: '0 0 * * 0'

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build project
        run: pnpm build

      - name: Run Lighthouse CI
        run: |
          npm install -g @lhci/cli@0.14.x
          lhci autorun --config=./.github/lighthouserc.json

      - name: Upload Lighthouse report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: lighthouse-report
          path: ./.lighthouseci/
          retention-days: 30

      - name: Run Web Vitals Test
        run: |
          npm install -g @web-vitals/cli
          web-vitals http://localhost:3000 --thresholds="LCP<2500,CLS<0.1,INP<200"

      - name: Run Bundle Analysis
        run: |
          npm install -g @next/bundle-analyzer
          NEXT_ANALYZE=true pnpm build

      - name: Upload bundle analysis
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: bundle-analysis
          path: .next/analyze/
          retention-days: 30

  # Compare with baseline
  compare:
    runs-on: ubuntu-latest
    needs: benchmark
    if: github.event_name == 'pull_request'
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'pnpm'

      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build and benchmark base branch
        run: |
          git fetch origin ${{ github.base_ref }}
          git checkout origin/${{ github.base_ref }}
          pnpm build
          npm install -g @lhci/cli@0.14.x
          lhci autorun --config=./.github/lighthouserc.json --upload.target=temporary-public-storage || true

      - name: Build and benchmark PR branch
        run: |
          git checkout ${{ github.sha }}
          pnpm build
          lhci autorun --config=./.github/lighthouserc.json --upload.target=temporary-public-storage

      - name: Comment PR with performance comparison
        uses: actions/github-script@v7
        if: github.event_name == 'pull_request'
        with:
          script: |
            const fs = require('fs');
            const path = require('path');

            // Read Lighthouse reports and compare
            const baseReport = fs.readFileSync('./.lighthouseci/base-manifest.json', 'utf8');
            const prReport = fs.readFileSync('./.lighthouseci/manifest.json', 'utf8');

            const baseData = JSON.parse(baseReport);
            const prData = JSON.parse(prReport);

            const comment = `
            ## ðŸš€ Performance Benchmark Results

            ### Lighthouse Scores

            | Metric | Base Branch | PR Branch | Change |
            |--------|-------------|-----------|--------|
            | Performance | ${baseData.categories.performance.score * 100} | ${prData.categories.performance.score * 100} | ${(prData.categories.performance.score - baseData.categories.performance.score) * 100} |
            | Accessibility | ${baseData.categories.accessibility.score * 100} | ${prData.categories.accessibility.score * 100} | ${(prData.categories.accessibility.score - baseData.categories.accessibility.score) * 100} |
            | Best Practices | ${baseData.categories['best-practices'].score * 100} | ${prData.categories['best-practices'].score * 100} | ${(prData.categories['best-practices'].score - baseData.categories['best-practices'].score) * 100} |
            | SEO | ${baseData.categories.seo.score * 100} | ${prData.categories.seo.score * 100} | ${(prData.categories.seo.score - baseData.categories.seo.score) * 100} |

            ### Core Web Vitals

            | Metric | Base Branch | PR Branch | Change |
            |--------|-------------|-----------|--------|
            | LCP | ${baseData.audits['largest-contentful-paint'].numericValue}ms | ${prData.audits['largest-contentful-paint'].numericValue}ms | ${prData.audits['largest-contentful-paint'].numericValue - baseData.audits['largest-contentful-paint'].numericValue}ms |
            | CLS | ${baseData.audits['cumulative-layout-shift'].numericValue} | ${prData.audits['cumulative-layout-shift'].numericValue} | ${prData.audits['cumulative-layout-shift'].numericValue - baseData.audits['cumulative-layout-shift'].numericValue} |
            | INP | ${baseData.audits['interactive'].numericValue}ms | ${prData.audits['interactive'].numericValue}ms | ${prData.audits['interactive'].numericValue - baseData.audits['interactive'].numericValue}ms |

            *Note: Positive changes indicate improvements.*
            `;

            github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });
